name: Build sunxi-tools (Win & Linux)

on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ "main", "master" ]

jobs:
  # ==========================================
  # 任务 1: 编译 Linux 版本 (Native Build)
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev pkg-config zlib1g-dev

      - name: Build
        run: |
          make
          # 整理输出文件
          mkdir output
          cp sunxi-fel output/
          cp sunxi-fisc-dump output/
          cp sunxi-nand-part output/
          cp sunxi-boot output/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-linux
          path: output/

  # ==========================================
  # 任务 2: 编译 Windows 版本 (Cross Compile)
  # ==========================================
  build-windows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Install MinGW & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 make pkg-config p7zip-full wget

      # 下载 Windows 版的 LibUSB 库文件 (因为是交叉编译，不能用 apt 安装的 linux libusb)
      - name: Download LibUSB for Windows
        run: |
          wget https://github.com/libusb/libusb/releases/download/v1.0.27/libusb-1.0.27-binaries.7z
          7z x libusb-1.0.27-binaries.7z -olibusb_win

      - name: Build for Windows
        run: |
          # 设置编译器为 MinGW-w64 (64位 Windows)
          export CC=x86_64-w64-mingw32-gcc
          
          # 指定头文件和库文件的路径 (指向刚才下载的 libusb_win)
          # -static: 静态链接，确保生成的 exe 不需要额外的 dll 就能运行
          export CFLAGS="-I$(pwd)/libusb_win/include/libusb-1.0 -O2 -Wall -Wextra"
          export LDFLAGS="-L$(pwd)/libusb_win/MinGW64/static -static"
          export LIBS="-lusb-1.0"
          
          # 开始编译核心工具
          $CC $CFLAGS -c fel.c -o fel.o
          $CC $CFLAGS -c fel-spiflash.c -o fel-spiflash.o
          $CC $CFLAGS -c progress.c -o progress.o
          
          # 链接生成 sunxi-fel.exe
          $CC $LDFLAGS -o sunxi-fel.exe fel.o fel-spiflash.o progress.o $LIBS
          
          # 编译 boot info 工具
          $CC $CFLAGS $LDFLAGS -o sunxi-boot.exe bootinfo.c $LIBS

          # 整理输出
          mkdir output
          mv *.exe output/

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-windows
          path: output/
