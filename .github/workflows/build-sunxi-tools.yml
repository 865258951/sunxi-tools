 name: Build sunxi-tools (Fix Missing DLL)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  # ==========================================
  # 任务 1: Linux 版本
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev pkg-config zlib1g-dev libfdt-dev device-tree-compiler

      - name: Build
        run: |
          make
          mkdir output
          cp sunxi-fel output/
          cp sunxi-nand-part output/
          cp sunxi-bootinfo output/
          cp sunxi-fexc output/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-linux
          path: output/

  # ==========================================
  # 任务 2: Windows 版本 (MSYS2)
  # ==========================================
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            gcc
            pkg-config
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-dtc

      - name: Build for Windows
        run: |
          make CC=gcc PKG_CONFIG=pkg-config

          # 整理输出
          mkdir output
          cp sunxi-fel.exe output/
          cp sunxi-bootinfo.exe output/
          cp sunxi-nand-part.exe output/
          cp sunxi-fexc.exe output/
          
          # --- 关键修复：复制所有依赖的 DLL ---
          echo "Copying dependencies..."
          cp /mingw64/bin/libusb-1.0.dll output/
          cp /mingw64/bin/zlib1.dll output/
          # 这里是之前缺失的文件：
          cp /mingw64/bin/libfdt-1.dll output/
          
          # 基础运行库
          cp /mingw64/bin/libwinpthread-1.dll output/
          cp /mingw64/bin/libgcc_s_seh-1.dll output/
          # 保险起见，加上标准C++库（有些环境的 libfdt 可能会依赖）
          cp /mingw64/bin/libstdc++-6.dll output/

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-windows
          path: output/
