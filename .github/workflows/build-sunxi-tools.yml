name: Build sunxi-tools (Fix Dependencies)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  # ==========================================
  # 任务 1: Linux 版本 (修复了 libfdt 报错)
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 关键修复：添加了 libfdt-dev 和 device-tree-compiler
          sudo apt-get install -y libusb-1.0-0-dev pkg-config zlib1g-dev libfdt-dev device-tree-compiler

      - name: Build
        run: |
          make
          # 整理输出
          mkdir output
          cp sunxi-fel output/
          cp sunxi-fisc-dump output/
          cp sunxi-nand-part output/
          cp sunxi-boot output/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-linux
          path: output/

  # ==========================================
  # 任务 2: Windows 版本 (使用 MSYS2 原生编译)
  # ==========================================
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          # 自动安装所有需要的 Windows 版依赖库
          install: >-
            git
            make
            gcc
            pkg-config
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-dtc

      - name: Build for Windows
        run: |
          # 编译所有工具
          make CC=gcc PKG_CONFIG=pkg-config

          # 整理输出
          mkdir output
          cp sunxi-fel.exe output/
          cp sunxi-boot.exe output/
          # 还需要拷贝依赖的 DLL，否则下载后无法运行
          cp /mingw64/bin/libusb-1.0.dll output/
          cp /mingw64/bin/zlib1.dll output/
          # 注意：libwinpthread-1.dll 和 libgcc_s_seh-1.dll 可能也需要
          cp /mingw64/bin/libwinpthread-1.dll output/
          cp /mingw64/bin/libgcc_s_seh-1.dll output/

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-windows
          path: output/
