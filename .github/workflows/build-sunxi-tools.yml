name: Build sunxi-tools (Fixed Copy Paths)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  # ==========================================
  # 任务 1: Linux 版本
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev pkg-config zlib1g-dev libfdt-dev device-tree-compiler

      - name: Build
        run: |
          make
          # 整理输出 (仅复制实际生成的关键工具)
          mkdir output
          cp sunxi-fel output/
          cp sunxi-nand-part output/
          cp sunxi-bootinfo output/
          cp sunxi-fexc output/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-linux
          path: output/

  # ==========================================
  # 任务 2: Windows 版本 (MSYS2)
  # ==========================================
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: linux-sunxi/sunxi-tools
          ref: master

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            gcc
            pkg-config
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-dtc

      - name: Build for Windows
        run: |
          make CC=gcc PKG_CONFIG=pkg-config

          # 整理输出 (修正了文件名)
          mkdir output
          cp sunxi-fel.exe output/
          cp sunxi-bootinfo.exe output/
          cp sunxi-nand-part.exe output/
          cp sunxi-fexc.exe output/
          
          # 复制依赖的 DLL (有了这些，你的 exe 才能在别的电脑运行)
          cp /mingw64/bin/libusb-1.0.dll output/
          cp /mingw64/bin/zlib1.dll output/
          cp /mingw64/bin/libwinpthread-1.dll output/
          cp /mingw64/bin/libgcc_s_seh-1.dll output/

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sunxi-tools-windows
          path: output/
